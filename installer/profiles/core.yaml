name: core
description: >-
  Core services required for the R.A.L.F. homelab environment. The profile installs
  databases, source control and automation runtimes in a dependency aware order.
components:
  - name: postgresql
    description: Primary relational database used for inventory and status data.
    tasks:
      - id: storage.prepare_volumes
        description: Prepare storage volumes for PostgreSQL
        parameters:
          target: postgresql
      - id: postgresql.deploy_runtime
        description: Deploy PostgreSQL container or VM
      - id: postgresql.configure_accounts
        description: Configure users and initial databases
        parameters:
          accounts:
            - ralf_core
            - automation_runtimes
  - name: gitea
    description: Git service hosting Infrastructure-as-Code and documentation.
    depends_on:
      - postgresql
    tasks:
      - id: gitea.deploy_runtime
        description: Provision Gitea runtime and required volumes
      - id: gitea.configure_database
        description: Configure database connection credentials
        parameters:
          database: postgresql
      - id: gitea.seed_repositories
        description: Seed repositories for automation and knowledge artifacts
        parameters:
          repositories:
            - infra/bootstrap
            - automation/playbooks
            - knowledge/base
  - name: vaultwarden
    description: Secrets management service for credentials and API tokens.
    depends_on:
      - postgresql
    tasks:
      - id: vaultwarden.deploy_service
        description: Deploy Vaultwarden service
      - id: vaultwarden.configure_admin
        description: Configure admin account and secrets storage
        parameters:
          admin_user: ralf-admin
      - id: vaultwarden.sync_bootstrap_secrets
        description: Synchronise bootstrap secrets with installation nodes
        parameters:
          targets:
            - automation
            - observability
  - name: automation
    description: Automation runtimes required by infrastructure agents.
    depends_on:
      - gitea
      - vaultwarden
    tasks:
      - id: automation.deploy_opentofu
        description: Deploy OpenTofu execution environment
      - id: automation.deploy_ansible
        description: Deploy Ansible control node
      - id: automation.register_credentials
        description: Register automation credentials in Vaultwarden
        parameters:
          credentials:
            - opentofu/api-token
            - ansible/ssh-key
  - name: observability
    description: Monitoring stack with Prometheus, Loki and Grafana.
    depends_on:
      - postgresql
      - automation
    tasks:
      - id: observability.deploy_prometheus
        description: Deploy Prometheus and scrape configuration
        parameters:
          scrape_targets:
            - postgresql
            - gitea
            - vaultwarden
      - id: observability.deploy_loki
        description: Deploy Loki for log aggregation
      - id: observability.provision_grafana
        description: Provision Grafana dashboards and data sources
        parameters:
          dashboards:
            - core-overview
            - automation-health
            - observability-stack
